Instructions:

- Add bot button in frontend doesn't work
- bullets shooting from towers should originate from the center

---

## Fix Plan

### Bug 1: Add Bot Button Not Working

**Analysis:**
- Frontend sends `LOBBY/ADD_BOT` command via `LobbyService.addBot()` (`frontend/src/app/core/services/lobby.service.ts:160-162`)
- Backend has proper routing: `AddBotHandler` → `AddBotListener` → `LobbyHandler.handleAddBot()`
- `Lobby.addBot()` validates: host-only, not started, lobby not full

**Diagnostic Steps:**
1. Check browser Network/Console for WebSocket messages when clicking "Add Bot"
2. Check server logs for incoming `LOBBY/ADD_BOT` command
3. Verify the host validation is passing (hostId matches requesterId)

**Likely Root Causes:**
- Command might not be reaching the handler (routing issue)
- Host validation failing if hostId not correctly set
- Missing error response handling in frontend

**Files to Investigate/Fix:**
- `src/main/java/be/lefief/sockets/handlers/routing/AddBotHandler.java`
- `src/main/java/be/lefief/sockets/handlers/lobby/AddBotListener.java`
- `src/main/java/be/lefief/lobby/Lobby.java` (line 202: `addBot()` method)
- `frontend/src/app/core/services/lobby.service.ts`

---

### Bug 2: Bullets Not Originating From Tower Center

**Analysis:**
- `drawBullets()` in `game.component.ts:1505-1531` calculates bullet positions
- Tower start position correctly uses `+0.5` offset to center on tile
- Target position does NOT use `+0.5` offset, targeting tile corner instead of center

**Current Code (line 1508-1511):**
```typescript
const startX = (attack.towerX + 0.5) * this.tileSize - this.cameraX;  // Centered
const startY = (attack.towerY + 0.5) * this.tileSize - this.cameraY;  // Centered
const endX = attack.targetX * this.tileSize - this.cameraX;           // NOT centered
const endY = attack.targetY * this.tileSize - this.cameraY;           // NOT centered
```

**Fix:**
Add `+0.5` offset to target coordinates so bullets aim at creep centers:
```typescript
const endX = (attack.targetX + 0.5) * this.tileSize - this.cameraX;
const endY = (attack.targetY + 0.5) * this.tileSize - this.cameraY;
```

**File to Fix:**
- `frontend/src/app/features/game/game.component.ts` (lines 1510-1511)

---

## Todo Checklist

### Bug 1: Add Bot Button
- [x] Add debug logging to `AddBotHandler` to confirm command is received
- [x] Add debug logging to frontend (`lobby-room.component.ts`, `lobby.service.ts`)
- [x] Add unit tests for `handleAddBot` (3 tests added to `LobbyHandlerTest.java`)
- [x] Verify host validation logic in `Lobby.addBot()` - **WORKS** (tests pass)
- [x] Test in browser - check WebSocket messages in Network tab
- [x] Check server console for `LOBBY/ADD_BOT` command logs
- [x] Test add bot functionality works end-to-end

**Status**: ✅ **VERIFIED WORKING** - Tested in browser on 2025-12-29:
- Console shows: `addBot() clicked`, `Sending: ADD_BOT`, `Received: LOBBY_STATE`
- Server logs: `AddBotListener.accept() called`, `handleAddBot: Successfully added bot`
- Bot appears in lobby with correct name, color, and ready status

### Bug 2: Bullet Origin
- [x] Update `drawBullets()` target coordinates to use `+0.5` offset
- [x] Verify code fix in `game.component.ts:1510-1511`
- [x] Confirm both start and end positions have centering offset

**Status**: ✅ **CODE FIX APPLIED** - The `+0.5` offset is now applied to both tower origin and target coordinates:
```typescript
const endX = (attack.targetX + 0.5) * this.tileSize - this.cameraX;
const endY = (attack.targetY + 0.5) * this.tileSize - this.cameraY;
```
Bullets will now travel from tower center to creep center (instead of tile corners).
