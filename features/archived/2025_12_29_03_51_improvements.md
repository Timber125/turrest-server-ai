Instructions:

- When a creep is despawned, a "+X gold" animation happens; I would like to generalize and improve this concept: Any time a "Reward" is granted, i want an animation in frontend.
- Similarly, everytime a cost is 'spent', i want an animation to appear indicating what was paid.
- Use colors to distinguish between type of reward and combinations of reward - add these colors and maybe icons to the general reward an cost system and initialize them properly for turrest01 game mode.
- Make sure the animation is smooth and visually pleasing, possibly adding appropriate audio sounds for certain cost origins (building buildings, sending creeps, ...?) and certain reward types (killing creeps, hitting a sent creep, ...?)

---

## Implementation Plan

### Current Architecture

**Existing Animation System:**
- `floatingTexts[]` array in `game.component.ts` stores `{x, y, text, color, age}`
- Animations move upward (0.5 tiles/sec), fade out over 1.5 seconds
- Currently only triggered by `DespawnCreepCommand` for creep kills

**Current Limitations:**
- Only gold rewards shown (no wood/stone/hitpoints)
- No cost animations at all
- Single gold color (#FFD700) for all rewards
- No audio system exists

---

### Part 1: Backend - Generalized Reward/Cost Event System

#### 1.1 Create Resource Animation Event Types

**New File: `src/main/java/be/lefief/game/turrest01/resource/ResourceEventType.java`**

```java
public enum ResourceEventType {
    // Rewards
    CREEP_KILL("kill"),           // Killed enemy creep with tower
    CREEP_HIT_CASTLE("hit"),      // Sent creep hit enemy castle
    RESOURCE_PRODUCTION("prod"),   // Passive production tick

    // Costs
    BUILD_BUILDING("build"),       // Placed a building
    BUILD_TOWER("tower"),          // Placed a tower
    SEND_CREEP("send");            // Sent a creep to opponents

    private final String id;
    // ... constructor, getter
}
```

#### 1.2 Create Unified Resource Event Command

**New File: `src/main/java/be/lefief/game/turrest01/commands/ResourceEventCommand.java`**

```java
public class ResourceEventCommand extends ServerToClientCommand {
    // Data:
    // - eventType: string (kill, hit, build, tower, send, prod)
    // - wood: int (positive = gain, negative = cost)
    // - stone: int
    // - gold: int
    // - hitpoints: int
    // - x: double (world position for animation)
    // - y: double
    // - playerNumber: int (who this affects)
}
```

This replaces the gold-only data in `DespawnCreepCommand` with a general-purpose event.

#### 1.3 Update Reward/Cost Application Points

**File: `CreepManager.java`**

When creep killed by towers:
```java
// Instead of just DespawnCreepCommand with gold
game.sendToPlayer(player, new ResourceEventCommand(
    ResourceEventType.CREEP_KILL,
    creep.getType().getKillReward(),  // full reward object
    creep.getX(), creep.getY(),
    playerNumber
));
```

When sent creep hits castle:
```java
game.sendToPlayer(sender, new ResourceEventCommand(
    ResourceEventType.CREEP_HIT_CASTLE,
    creep.getType().getHitReward(),
    creep.getX(), creep.getY(),
    senderPlayerNumber
));
```

**File: `Turrest01GameHandler.java`**

When building placed:
```java
game.sendToPlayer(player, new ResourceEventCommand(
    ResourceEventType.BUILD_BUILDING,
    buildingDef.getCost().negate(),  // negative = cost
    tileX, tileY,
    playerNumber
));
```

When tower placed:
```java
game.sendToPlayer(player, new ResourceEventCommand(
    ResourceEventType.BUILD_TOWER,
    towerDef.getCost().negate(),
    tileX, tileY,
    playerNumber
));
```

When creep sent:
```java
// Position at player's action panel or center of screen
game.sendToPlayer(player, new ResourceEventCommand(
    ResourceEventType.SEND_CREEP,
    creepType.getSendCost().negate(),
    playerCenterX, playerCenterY,
    playerNumber
));
```

#### 1.4 Add Negate Method to TurrestCost

**File: `TurrestCost.java`**

```java
public TurrestReward negate() {
    return new TurrestReward(-wood, -stone, -gold, -hitpoints);
}
```

Or create a new class `ResourceDelta` that can be positive or negative.

---

### Part 2: Frontend - Enhanced Animation System

#### 2.1 Enhanced Floating Text Interface

**File: `game.component.ts`**

```typescript
interface FloatingText {
  x: number;
  y: number;
  age: number;
  entries: FloatingTextEntry[];  // Multiple resource types per animation
}

interface FloatingTextEntry {
  text: string;        // "+15" or "-80"
  icon: string;        // "gold", "wood", "stone", "hp"
  color: string;       // Resource-specific color
}
```

#### 2.2 Resource Color Scheme

```typescript
const RESOURCE_COLORS = {
  gold: '#FFD700',      // Gold/yellow
  wood: '#8B4513',      // Brown
  stone: '#708090',     // Slate gray
  hitpoints: '#FF4444', // Red for HP

  // Event-specific accent colors (optional)
  kill: '#00FF00',      // Green flash for kills
  hit: '#FF8800',       // Orange for castle hits
  build: '#4488FF',     // Blue for construction
};
```

#### 2.3 Icon Rendering (Optional SVG or Emoji)

Simple approach with Unicode symbols:
```typescript
const RESOURCE_ICONS = {
  gold: '‚óè',     // or ü™ô
  wood: '‚ñ≤',     // or ü™µ
  stone: '‚ñ†',    // or ü™®
  hitpoints: '‚ô•' // or ‚ù§Ô∏è
};
```

Or load small SVG/PNG icons for each resource type.

#### 2.4 Enhanced Floating Text Rendering

**File: `game.component.ts` - `drawFloatingTexts()`**

```typescript
drawFloatingTexts() {
  for (const ft of this.floatingTexts) {
    const alpha = 1 - (ft.age / 1.5);
    let yOffset = 0;

    for (const entry of ft.entries) {
      // Draw icon
      this.ctx.fillStyle = entry.color + hexAlpha(alpha);
      this.ctx.fillText(entry.icon, screenX, screenY + yOffset);

      // Draw value
      this.ctx.fillText(entry.text, screenX + iconWidth, screenY + yOffset);

      yOffset += lineHeight;
    }
  }
}
```

#### 2.5 Animation Variations by Event Type

| Event Type | Animation Style | Duration | Direction |
|------------|-----------------|----------|-----------|
| CREEP_KILL | Float up, fade | 1.5s | ‚Üë |
| CREEP_HIT_CASTLE | Pulse + float | 2.0s | ‚Üë |
| BUILD_BUILDING | Expand from center | 1.0s | ‚Üë |
| BUILD_TOWER | Expand from center | 1.0s | ‚Üë |
| SEND_CREEP | Slide right | 1.0s | ‚Üí |

---

### Part 3: Audio System

#### 3.1 Create Audio Service

**New File: `frontend/src/app/core/services/audio.service.ts`**

```typescript
@Injectable({ providedIn: 'root' })
export class AudioService {
  private audioContext: AudioContext;
  private sounds: Map<string, AudioBuffer> = new Map();
  private volume = 0.5;

  async loadSounds() {
    await this.load('coin', '/assets/audio/coin.mp3');
    await this.load('build', '/assets/audio/build.mp3');
    await this.load('send', '/assets/audio/send.mp3');
    await this.load('hit', '/assets/audio/hit.mp3');
    await this.load('kill', '/assets/audio/kill.mp3');
  }

  play(soundId: string, volume?: number) {
    const buffer = this.sounds.get(soundId);
    if (buffer) {
      const source = this.audioContext.createBufferSource();
      source.buffer = buffer;
      // ... gain node, connect, start
    }
  }

  setVolume(volume: number) { this.volume = volume; }
  mute() { this.volume = 0; }
}
```

#### 3.2 Audio Files to Source/Create

| Sound ID | Event | Description |
|----------|-------|-------------|
| `coin` | CREEP_KILL, CREEP_HIT_CASTLE | Coin/cha-ching sound |
| `build` | BUILD_BUILDING | Construction/hammer sound |
| `tower` | BUILD_TOWER | Metal/placement sound |
| `send` | SEND_CREEP | Whoosh/spawn sound |
| `hit` | CREEP_HIT_CASTLE | Impact/damage sound |

#### 3.3 Connect Audio to Events

**File: `game.component.ts`**

```typescript
handleResourceEvent(data: ResourceEventData) {
  // Create floating text animation
  this.createFloatingText(data);

  // Play appropriate sound
  switch (data.eventType) {
    case 'kill':
      this.audioService.play('coin');
      break;
    case 'hit':
      this.audioService.play('hit');
      this.audioService.play('coin', 0.5); // quieter coin
      break;
    case 'build':
      this.audioService.play('build');
      break;
    case 'tower':
      this.audioService.play('tower');
      break;
    case 'send':
      this.audioService.play('send');
      break;
  }
}
```

---

### Part 4: Files to Create/Modify

#### Backend (Java)

| File | Action | Purpose |
|------|--------|---------|
| `ResourceEventType.java` | CREATE | Enum for event types |
| `ResourceEventCommand.java` | CREATE | Unified event command |
| `TurrestCost.java` | MODIFY | Add `negate()` method |
| `TurrestReward.java` | MODIFY | Support negative values or create `ResourceDelta` |
| `CreepManager.java` | MODIFY | Send ResourceEventCommand on kills/hits |
| `Turrest01GameHandler.java` | MODIFY | Send ResourceEventCommand on builds/sends |

#### Frontend (TypeScript)

| File | Action | Purpose |
|------|--------|---------|
| `audio.service.ts` | CREATE | Audio playback service |
| `game.component.ts` | MODIFY | Enhanced floating text system |
| `game.model.ts` | MODIFY | Add ResourceEvent interface |
| `socket-topics.ts` | MODIFY | Add RESOURCE_EVENT topic |
| `assets/audio/*.mp3` | CREATE | Sound effect files |

---

### Part 5: Implementation Order

1. **Backend: Event Command**
   - Create `ResourceEventType` enum
   - Create `ResourceEventCommand` class
   - Add socket topic for new command

2. **Backend: Integration**
   - Update `CreepManager` kill/hit logic
   - Update `Turrest01GameHandler` build/send logic
   - Keep existing `DespawnCreepCommand` for backwards compatibility initially

3. **Frontend: Animation System**
   - Refactor `floatingTexts` to support multiple resource types
   - Add color constants and icon mapping
   - Update `drawFloatingTexts()` for enhanced rendering
   - Add listener for `RESOURCE_EVENT` command

4. **Frontend: Audio System**
   - Create `AudioService`
   - Source/create audio files
   - Integrate audio with resource events

5. **Polish**
   - Tune animation durations and easing
   - Adjust audio volumes and mixing
   - Add user settings for audio volume/mute

---

### Visual Design Reference

**Reward Animation (Positive):**
```
    ü™ô +15
    ü™µ +5
```
- Green/gold tint
- Float upward
- Fade out

**Cost Animation (Negative):**
```
    ü™µ -80
    ü™® -80
    ü™ô -100
```
- Red/gray tint
- Float upward from build location
- Fade out

**Combined (Hit Reward with HP cost from sendCost):**
```
    ü™ô +35
    ‚ô• -0
```

---

### Testing Checklist

- [ ] Kill creep with tower ‚Üí gold animation + coin sound
- [ ] Sent creep hits castle ‚Üí gold animation at sender + hit sound
- [ ] Place building ‚Üí cost animation + build sound
- [ ] Place tower ‚Üí cost animation + tower sound
- [ ] Send creep ‚Üí cost animation + send sound
- [ ] Multiple resources in single event display correctly
- [ ] Audio volume control works
- [ ] Animations don't overlap/clutter
- [ ] Performance stable with many animations
